U
    ร4รคbย#  รฃ                   @   sรฐ  d Z ddlZddlm  mZ ddl Z ddlZddl	Z	ddl
Z
ddl
Zddl
Z
ddlZddlmZ ddlmZ ddlmZ ddlmZmZmZmZ G d dโ deฦZd(d	d
โZd
dโ Zd
dโ Zddโ Zddโ Z d)ddโZ!ddโ Z"ddโ Z#ddโ Z$ej%ยrโeeฦZ&e&ย'de#gยก e&ย'de$gยก e&ย'dde"gยก e&ย'dde"gยก e&ย(ยก  eeee fD ]Z)ee)ฦZ&e&ย(ยก  ยqNee!ฦZ&e&ย'dde"gยก e&ย'dde"gยก e&ย(ยก  e	j*ย+e,ยกZ-e	j*ย.e	j*ย/e-ddd ยกยกZ0e
j1ย2d!d"d#gยกe
j1ย2d$e3e4d%ฦฦยกd&d'โ ฦฦZ5dS )*a$  


รฉ    N)รClock)ร
RisingEdge)ร
TestFactory)รAxiStreamBusรAxiStreamFrameรAxiStreamSourceร
AxiStreamSinkc                   @   s0   e Zd Zddโ Zd
ddโZd
dd โZdd	โ ZdS )รTBc                  C   sr   || _ tยdยก| _| jยtjยก tย t|j	dddยย
ยก ยก t
tย
|dยก|j	|jฦ| _ttย
|dยก|j	|jฦ| _d S ) Nz	cocotb.tbรฉ
   รns)รunitsZs_axisZm_axis)รdutร loggingร	getLoggerรlogรsetLevelรDEBUGรcocotbร
start_soonr   รclkรstartr    r   Z
from_prefixรrstรsourcer   รsink)รselfr
   ยฉ r   รบ>/home/user/axis_fifo_1/axis_fifo_buggy/test_axis_fifo_buggy.pyร__init__+   s    z
TB.__init__Nc                 C   s   |r| j ย|ฦ ยก d S ยฉN)r   รset_pause_generatorยฉr   ร	generatorr   r   r   รset_idle_generator6   s    zTB.set_idle_generatorc                 C   s   |r| j ย|ฦ ยก d S r   )r   r   r    r   r   r   รset_backpressure_generator:   s    zTB.set_backpressure_generatorc                 ร   sโ   | j jยdยก t| j jฦI d H  t| j jฦI d H  d| j j_t| j jฦI d H  t| j jฦI d H  d| j j_t| j jฦI d H  t| j jฦI d H  d S )Nr   รฉ   )r
   r   รsetimmediatevaluer   r   รvalue)r   r   r   r   รreset>   s    

zTB.reset)N)N) ร__name__ร
__module__ร__qualname__r   r"   r#   r'   r   r   r   r   r	   *   s   


r	   c                 ฦ   sร  t | ฦ}dt|jjjฦ }d} |ยยก I d H  |ย|ยก |ย |ยก g }โก fddโ|ฦ D ฦD ]@}	t|	ฦ}
| |
_| |
_	|ย
|
ยก |jย
|
ยกI d H  | d | } qX|D ย]ลก}
|jย
ยก I d H }
|
j}|
j}
||
k}|ยs^tยd|fd||
fยกd tยยก ksรบtย|
ยกยrtย|
ยกnd tย|ยกdtยยก kยs(tย|
ยกยr2tย|
ยกndtย|
ยกd	ล }d
d
|i }ttย|ยกฦโd  } }}
|
j}|
j}
||
k}|ยstยd|fd||
fยกd tยยก kยsยฒtย|
ยกยrยผtย|
ยกnd tย|ยกdtยยก kยsรtย|
ยกยrรชtย|
ยกndtย|
ยกd	ล }d
d
|i }ttย|ยกฦโd  } }}
|
j	}|
j	}
||
k}|ยsรtยd|fd
||
fยกd tยยก kยsjtย|
ยกยrttย|
ยกnd tย|ยกdtยยก kยsหtย|
ยกยrยขtย|
ยกndtย|
ยกd	ล }d
d
|i }ttย|ยกฦโd  } }}
|
j}| }|ยs2dd tยยก kยstย|
ยกยrtย|
ยกnd tย|ยกdล }ttย|ยกฦโd  }}qลพ|j}|j}|ฦ }
|
ยsยชddtยยก kยsptย|ยกยrztย|ยกndtย|ยกtย|ยกtย|
ยกd	ล }ttย|ยกฦโd  } }}
t| jฦI d H  t| jฦI d H  d S )Nรฉ   r$   c                    s   g | ]}ห |ฦโqS r   r   )ร.0รxยฉรpayload_datar   r   ร
<listcomp>Y   s     zrun_test.<locals>.<listcomp>ยฉรบ==ยฉzH%(py2)s
{%(py2)s = %(py0)s.tdata
} == %(py6)s
{%(py6)s = %(py4)s.tdata
}รrx_frameร
test_frameยฉรpy0รpy2รpy4รpy6รบassert %(py8)sรpy8ยฉzD%(py2)s
{%(py2)s = %(py0)s.tid
} == %(py6)s
{%(py6)s = %(py4)s.tid
}ยฉzH%(py2)s
{%(py2)s = %(py0)s.tdest
} == %(py6)s
{%(py6)s = %(py4)s.tdest
}รบ-assert not %(py2)s
{%(py2)s = %(py0)s.tuser
}ยฉr7   r8   รบZassert %(py6)s
{%(py6)s = %(py4)s
{%(py4)s = %(py2)s
{%(py2)s = %(py0)s.sink
}.empty
}()
}รtb)r	   รlenr   รbusรtidr'   r"   r#   r   รtdestรappendรsendr   รrecvรtdataร
@pytest_arร_call_reprcompareร@py_builtinsรlocalsร_should_repr_global_nameร	_safereprรAssertionErrorร_format_explanationรtuserรemptyr   r   )r
   รpayload_lengthsr/   ร
idle_inserterรbackpressure_inserterrB   รid_countรcur_idร
test_framesร	test_datar5   r4   ร
@py_assert1ร
@py_assert5ร
@py_assert3ร
@py_format7ร
@py_format9ร
@py_format4r   r.   r   รrun_testJ   sn    



    v       x       x      8  
    H  rb   c           
       ร   sรฎ  t | ฦ}|ยยก I d H  ttยtยtdฦยกdยกฦ}t |ddย}|jย	|ยกI d H  |j
ย
ยก I d H }|j}||k}|sรฒt
ยd|fd||fยกd tยยก ksลกt
ย|ยกrยคt
ย|ยกnd t
ย|ยกdtยยก ksรt
ย|ยกrรt
ย|ยกndd	ล } d
d
| i }tt
ย|ยกฦโd  }}|j}|ยsLdd tยยก kยs"t
ย|ยกยr,t
ย|ยกnd t
ย|ยกd
ล }	tt
ย|	ยกฦโd }|j
}|j}|ฦ }
|
ยsยพddtยยก kยsโt
ย|ยกยrลฝt
ย|ยกndt
ย|ยกt
ย|ยกt
ย|
ยกdล }tt
ย|ยกฦโd  } }}
t| jฦI d H  t| jฦI d H  d S )Nรฉ   รฉ    r$   )rS   r1   ยฉz-%(py2)s
{%(py2)s = %(py0)s.tdata
} == %(py4)sr4   r[   ยฉr7   r8   r9   รบassert %(py6)sr:   z)assert %(py2)s
{%(py2)s = %(py0)s.tuser
}r@   rA   rB   r6   )r	   r'   ร	bytearrayร	itertoolsรisliceรcycleรranger   r   rH   r   rI   rJ   rK   rL   rM   rN   rO   rP   rQ   rR   rS   rT   r   r   )
r
   rB   r[   r5   r4   r\   r^   ร
@py_format5r_   Z
@py_format3r]   r   r   r   รrun_test_tuser_assertq   s6       h     8      H  rn   c                  ร   s$  t | ฦ}|ยยก I d H  d|j_ttยtย tdฦยกdยกฦ}t	|ฦ}|j
ย
|ยกI d H  tdฦD ]}t| j
ฦI d H  qZd|j_|jยยก I d H }|j}||k} | ยstยd| fd ||fยกdtยยก ksรtย|ยกrรtย|ยกndtย|ยกd	tยยก ksรฐtย|ยกrรบtย|ยกnd	d
ล }d
d|i }	ttย|	ยกฦโd  }} |j}| } | ยs~d
dtยยก kยsTtย|ยกยr^tย|ยกndtย|ยกdล }
ttย|
ยกฦโd  }} |j}|j} | ฦ }
|
ยsรดddtยยก kยsยบtย|ยกยrรtย|ยกndtย|ยกtย| ยกtย|
ยกdล }	ttย|	ยกฦโd  } } }
t| j
ฦI d H  t| j
ฦI d H  d S )NTrc   rd   รฉ@   Fr1   re   r4   r[   rf   rg   r:   r?   r@   rA   rB   r6   ยฉr	   r'   r   รpauserh   ri   rj   rk   rl   r   r   rH   r   r   rI   rJ   rK   rL   rM   rN   rO   rP   rQ   rR   rS   rT   ยฉr
   rB   r[   r5   รkr4   r\   r^   rm   r_   ra   r]   r   r   r   รrun_test_init_sink_pauseโ   s@       h      8      H  rt   c           	       ร   s>  t | ฦ}|ยยก I d H  d|j_ttยtย tdฦยกdยกฦ}t	|ฦ}|j
ย
|ยกI d H  tdฦD ]}t| j
ฦI d H  qZ|ยยก I d H  d|j_tdฦD ]}t| j
ฦI d H  qลฝ|j}|j}|ฦ } | ยsdd tยยก ksรtย|ยกrรtย|ยกnd tย|ยกtย|ยกtย| ยกdล }ttย|ยกฦโd  } }} t| j
ฦI d H  t| j
ฦI d H  d S )	NTrc   rd   ro   FrA   rB   r6   )r	   r'   r   rq   rh   ri   rj   rk   rl   r   r   rH   r   r   rT   rM   rN   rK   rO   rP   rQ   rR   )	r
   rB   r[   r5   rs   r\   r^   r]   r_   r   r   r   รrun_test_init_sink_pause_resetยข   s*        D  ru   c                  ร   s$  t | ฦ}|ยยก I d H  d|j_ttยtย tdฦยกdยกฦ}t	|ฦ}|j
ย
|ยกI d H  tdฦD ]}t| j
ฦI d H  qZd|j_|jยยก I d H }|j}||k} | ยstยd| fd||fยกd tยยก ksรtย|ยกrรtย|ยกnd tย|ยกdtยยก ksรฐtย|ยกrรบtย|ยกndd	ล }d
d
|i }	ttย|	ยกฦโd  }} |j}| } | ยs~dd tยยก kยsTtย|ยกยr^tย|ยกnd tย|ยกd
ล }
ttย|
ยกฦโd  }} |j}|j} | ฦ }
|
ยsรดddtยยก kยsยบtย|ยกยrรtย|ยกndtย|ยกtย| ยกtย|
ยกdล }	ttย|	ยกฦโd  } } }
t| j
ฦI d H  t| j
ฦI d H  d S )NTrc   i   Fr1   re   r4   r[   rf   rg   r:   r?   r@   rA   rB   r6   rp   rr   r   r   r   รrun_test_overflowยพ   s@       h      8      H  rv   c                 ร   s  t | ฦ}|jj}dt|jjjฦ }d}|ยยก I d H  |ย |ยก |ย|ยก g } t	dฦD ]j}t
ย
d|d ยก}	tt
ยt
ยt	dฦยก|	ยกฦ}
t|
ฦ}
||
_||
_| ย|
ยก |jย|
ยกI d H  |d | }qT| D ย]ล}
|jยยก I d H }|j}
|
j}|
|k}|ยsโtยd|fd |
|fยกdtยยก kยs"tย|ยกยr,tย|ยกndtย|
ยกd	tยยก kยsPtย|
ยกยrZtย|
ยกnd	tย|ยกd
ล }d
d|i }ttย|ยกฦโd  }
 }}|j}
|
j}|
|k}|ยs>tยd|fd
|
|fยกdtยยก kยsรtย|ยกยrรคtย|ยกndtย|
ยกd	tยยก kยstย|
ยกยrtย|
ยกnd	tย|ยกd
ล }d
d|i }ttย|ยกฦโd  }
 }}|j}
|
j}|
|k}|ยsรถtยd|fd|
|fยกdtยยก kยsโtย|ยกยrลtย|ยกndtย|
ยกd	tยยก kยsรtย|
ยกยrรtย|
ยกnd	tย|ยกd
ล }d
d|i }ttย|ยกฦโd  }
 }}|j}
|
 }|ยsZddtยยก kยs0tย|ยกยr:tย|ยกndtย|
ยกdล }ttย|ยกฦโd  }
}qร|j}
|
j }|ฦ }|ยsรddtยยก kยsหtย|ยกยrยขtย|ยกndtย|
ยกtย|ยกtย|ยกd
ล }ttย|ยกฦโd  }
 }}t!| j"ฦI d H  t!| j"ฦI d H  d S )Nr+   r$   รฉโฌ   รฉ   rc   r1   r3   r4   r5   r6   r;   r<   r=   r>   r?   r@   rA   rB   )#r	   r   ร
byte_lanesrC   rD   rE   r'   r"   r#   rl   รrandomร randintrh   ri   rj   rk   r   rF   rG   rH   r   rI   rJ   rK   rL   rM   rN   rO   rP   rQ   rR   rS   rT   r   r   )r
   rV   rW   rB   ry   rX   rY   rZ   rs   รlengthr[   r5   r4   r\   r]   r^   r_   r`   ra   r   r   r   รrun_stress_testร   st    



    x       x       x      8  
    H  r}   c                   C   s   t ยddddgยกS )Nr$   r   )ri   rk   r   r   r   r   ร
cycle_pause  s    r~   c                  C   s:   t tjjฦ} | d }ttd|d d ฦฦdg dgd  S )Nรฉ   r$   รฉ   i   ro   )rC   r   รtopZm_axis_tdataรlistrl   )ร
data_widthZ
byte_widthr   r   r   ร	size_list  s    rโ   c                  C   s   t tยtยtdฦยก| ยกฦS )Nrc   )rh   ri   rj   rk   rl   )r|   r   r   r   รincrementing_payload  s    rโฆ   rU   r/   rV   rW   z..Zrtlrฦ   r   rx   r|   รฉ   c           
   	   C   s   d}t jยt jยtยกยกd }|}t jยt|โบ dยยกg}i } || d< t | d dkฦ| d< | d d  d | d	< d
| d
< d
| d< d
| d< d
| d< d
| d< d
| d< d
| d< || d< ddโ | ยยก D ฦ}t jยt	d| j
j
ยddยกยddยกยก}	t
jjt	g|||| |	|dย  d S )Nรaxis_fifo_buggyr   z.vZ
DATA_WIDTHr
   Z
KEEP_ENABLEรฉ    รฉ	   Z
KEEP_WIDTHr$   Z
LAST_ENABLEZ	ID_ENABLEr   ZID_WIDTHZ
DEST_ENABLEZ
DEST_WIDTHZ
USER_ENABLEZ
USER_WIDTHZLENGTHc                 S   s    i | ]\}}d |โบ ยt |ฦโqS )ZPARAM_)รstr)r,   rs   รvr   r   r   ร
<dictcomp>J  s      z(test_axis_fifo_buggy.<locals>.<dictcomp>ร	sim_buildรบ[รบ-รบ]ร ) Z
python_searchรverilog_sourcesรtoplevelรmoduleร
parametersrย   ร	extra_env)รosรpathรsplitextรbasenameร__file__รjoinร rtl_dirรintรitemsร	tests_dirรnodeรnameร replaceร
cocotb_testร	simulatorรrun)
ร requestr|   rฦ   r
   rโ   rโ   rโ   rโข   rโ   rย   r   r   r   รtest_axis_fifo_buggy1  s<    รฟ
รฟรนrยจ   )NNNN)NN)6ร __doc__รbuiltinsrM   ร_pytest.assertion.rewriteร	assertionร rewriterK   ri   r   rโ   rz   Zcocotb_test.simulatorrยค   รpytestr   Zcocotb.clockr   รcocotb.triggersr   รcocotb.regressionr   Z
cocotbext.axir   r   r    r   รobjectr	   rb   rn   rt   ru   rv   r}   r~   rโ   rโฆ   รSIM_NAMEร factoryร
add_optionรgenerate_testsรtestrห   ร dirnamerโบ   rย   ร abspathrล   rย   รmarkร
parametrizerโ   rl   rยจ   r   r   r   r   ร<module>   s\      
'
*รผ 
